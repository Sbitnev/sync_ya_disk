# Логирование

Проект использует библиотеку [loguru](https://github.com/Delgan/loguru) для продвинутого логирования.

## Конфигурация

Логирование настроено в `src/main.py` с тремя отдельными файлами:

```python
# Консольный вывод (INFO и выше)
logger.add(
    sys.stderr,
    format="<green>{time:HH:mm:ss}</green> | <level>{level: <8}</level> | <level>{message}</level>",
    level="INFO",
    colorize=True
)

# 1. Основной файл - все события (DEBUG и выше)
logger.add(
    "logs/sync_ya_disk.log",
    format="{time:YYYY-MM-DD HH:mm:ss} | {level: <8} | {message}",
    level="DEBUG",
    rotation="10 MB",
    retention="7 days",
    compression="zip"
)

# 2. Файл только для ошибок (ERROR и выше)
logger.add(
    "logs/errors.log",
    format="{time:YYYY-MM-DD HH:mm:ss} | {level: <8} | {message}",
    level="ERROR",
    rotation="5 MB",
    retention="30 days",
    compression="zip"
)

# 3. Файл для предупреждений и ошибок (WARNING и выше)
logger.add(
    "logs/warnings.log",
    format="{time:YYYY-MM-DD HH:mm:ss} | {level: <8} | {message}",
    level="WARNING",
    rotation="5 MB",
    retention="14 days",
    compression="zip"
)
```

## Структура логов

В проекте используется **трехуровневая система логирования**:

### 1. `logs/sync_ya_disk.log` - Полный лог
- **Уровень**: DEBUG и выше
- **Содержимое**: Все события приложения
- **Ротация**: 10 МБ
- **Хранение**: 7 дней
- **Назначение**: Полная история синхронизации, детальная отладка

### 2. `logs/errors.log` - Только ошибки
- **Уровень**: ERROR и CRITICAL
- **Содержимое**: Только критические ошибки
- **Ротация**: 5 МБ
- **Хранение**: 30 дней
- **Назначение**: Быстрый анализ проблем, мониторинг

### 3. `logs/warnings.log` - Предупреждения и ошибки
- **Уровень**: WARNING, ERROR и CRITICAL
- **Содержимое**: Предупреждения и ошибки
- **Ротация**: 5 МБ
- **Хранение**: 14 дней
- **Назначение**: Анализ потенциальных проблем

### Когда использовать какой файл?

| Задача | Файл | Зачем |
|--------|------|-------|
| Найти почему синхронизация упала | `errors.log` | Быстрый доступ только к ошибкам |
| Проанализировать сетевые проблемы | `warnings.log` | Видны retry попытки и таймауты |
| Отладка конкретного файла | `sync_ya_disk.log` | Полная информация включая DEBUG |
| Ежедневный мониторинг | `errors.log` | Проверка на наличие критических проблем |

## Уровни логирования

- **DEBUG** - детальная отладочная информация (только в файле)
  - Детали HTTP запросов
  - Параметры API вызовов
  - Информация о retry попытках

- **INFO** - общая информация о процессе (консоль + файл)
  - Начало/завершение операций
  - Статистика по файлам
  - Прогресс выполнения

- **SUCCESS** - успешные операции (консоль + файл)
  - Скачанные файлы
  - Завершенные этапы
  - Финальная статистика

- **WARNING** - предупреждения (консоль + файл)
  - Проблемы с API
  - Файлы без ссылок для скачивания
  - Retry попытки

- **ERROR** - ошибки (консоль + файл)
  - Сетевые ошибки
  - Проблемы с файловой системой
  - Критические ошибки API

## Примеры вывода

### Консоль
```
12:07:52 | INFO     | Начало синхронизации с: https://disk.yandex.ru/d/...
12:07:52 | INFO     | Директория для скачивания: C:\Users\...\downloaded_files
12:07:53 | INFO     | Получение списка файлов...
12:07:55 | SUCCESS  | Создано папок: 42
12:08:00 | SUCCESS  | Скачан: docs/report.pdf (2.5 МБ)
12:08:01 | WARNING  | Ошибка при скачивании file.txt (попытка 1/3)
12:08:04 | SUCCESS  | Скачан: file.txt (1.2 КБ)
```

### Файл (logs/sync_ya_disk.log)
```
2025-01-13 12:07:52 | INFO     | Начало синхронизации с: https://disk.yandex.ru/d/...
2025-01-13 12:07:52 | DEBUG    | ConnectionError: Connection timeout
2025-01-13 12:07:54 | WARNING  | Ошибка соединения (попытка 1/3)
2025-01-13 12:07:56 | DEBUG    | Retry successful
2025-01-13 12:08:00 | SUCCESS  | Скачан: docs/report.pdf (2.5 МБ)
```

### Файл (logs/errors.log) - Только ошибки
```
2025-01-13 12:10:15 | ERROR    | Не удалось скачать файл test.xlsx после 3 попыток
2025-01-13 12:15:42 | ERROR    | Ошибка конвертации CSV: UTF-16 stream does not start with BOM
2025-01-13 21:37:28 | ERROR    | Критическая ошибка: database or disk is full
```

### Файл (logs/warnings.log) - Предупреждения и ошибки
```
2025-01-13 12:07:54 | WARNING  | Ошибка соединения (попытка 1/3)
2025-01-13 12:09:12 | WARNING  | Ошибка при скачивании file.docx (попытка 2/3)
2025-01-13 12:10:15 | ERROR    | Не удалось скачать файл test.xlsx после 3 попыток
2025-01-13 21:37:28 | ERROR    | Критическая ошибка: database or disk is full
```

## Ротация логов

Каждый лог-файл имеет свои настройки ротации и хранения:

| Файл | Размер ротации | Срок хранения | Сжатие |
|------|----------------|---------------|--------|
| `sync_ya_disk.log` | 10 МБ | 7 дней | .zip |
| `errors.log` | 5 МБ | 30 дней | .zip |
| `warnings.log` | 5 МБ | 14 дней | .zip |

**Особенности:**
- Файлы автоматически ротируются при достижении указанного размера
- Старые логи автоматически сжимаются в .zip архивы
- После истечения срока хранения файлы удаляются автоматически
- Формат архивов: `logs/errors.log.2026-01-20_12-00-00.zip`
- Все логи находятся в папке `logs/`

**Зачем разные сроки хранения?**
- `errors.log` хранится 30 дней - для отслеживания повторяющихся проблем
- `warnings.log` хранится 14 дней - для анализа тенденций
- `sync_ya_disk.log` хранится 7 дней - полный лог занимает много места

## Настройка уровня логирования

Чтобы изменить уровень логирования в консоли на DEBUG:

```python
logger.remove()
logger.add(
    sys.stderr,
    level="DEBUG",  # Изменено с INFO на DEBUG
    colorize=True
)
```

Чтобы отключить файловое логирование:

```python
# Закомментируйте второй logger.add()
# logger.add("logs/sync_ya_disk.log", ...)
```

## Логи и производительность

Логирование оптимизировано для минимального влияния на производительность:
- Асинхронная запись в файл
- Буферизация сообщений
- Условное форматирование
- Цветной вывод только в терминале

Даже при DEBUG уровне на производительность влияние минимально (<1%).
