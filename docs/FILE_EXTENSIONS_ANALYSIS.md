# Анализ расширений файлов в папке /Клиенты

Дата анализа: 14 января 2026

## Общая статистика

- **Всего файлов**: 7,184
- **Всего папок**: 926
- **Общий размер**: 201.0 ГБ
- **Типов файлов**: 48 различных расширений + 4 файла без расширения

## Топ-20 расширений по количеству файлов

| № | Расширение | Количество | Общий размер | % от всех файлов |
|---|------------|------------|--------------|------------------|
| 1 | .xlsx | 3,080 | 5.9 ГБ | 42.9% |
| 2 | .docx | 1,127 | 817.1 МБ | 15.7% |
| 3 | .csv | 507 | 40.5 МБ | 7.1% |
| 4 | .pdf | 468 | 396.2 МБ | 6.5% |
| 5 | .parquet | 413 | 19.7 МБ | 5.7% |
| 6 | .mp4 | 370 | 59.1 МБ | 5.2% |
| 7 | .xlsm | 348 | 1.5 ГБ | 4.8% |
| 8 | .webm | 237 | 61.2 МБ | 3.3% |
| 9 | .png | 95 | 33.1 МБ | 1.3% |
| 10 | .xls | 82 | 134.0 МБ | 1.1% |
| 11 | .pptx | 73 | 134.5 МБ | 1.0% |
| 12 | .doc | 63 | 9.3 МБ | 0.9% |
| 13 | .zip | 62 | 10.7 МБ | 0.9% |
| 14 | .mpp | 44 | 93.7 МБ | 0.6% |
| 15 | .txt | 41 | 562.0 КБ | 0.6% |
| 16 | .jpg | 24 | 4.6 МБ | 0.3% |
| 17 | .avsc | 24 | 44.3 КБ | 0.3% |
| 18 | .drawio | 22 | 5.9 МБ | 0.3% |
| 19 | .tmp | 18 | 24.3 МБ | 0.3% |
| 20 | .epf | 11 | 287.0 КБ | 0.2% |

## Категории файлов

### Офисные документы (5,160 файлов, 71.8%)

#### Microsoft Excel
- `.xlsx` - 3,080 файлов (5.9 ГБ)
- `.xlsm` - 348 файлов (1.5 ГБ)
- `.xls` - 82 файлов (134.0 МБ)
- `.xlsb` - 2 файла (263.6 МБ)

#### Microsoft Word
- `.docx` - 1,127 файлов (817.1 МБ)
- `.doc` - 63 файла (9.3 МБ)

#### Microsoft PowerPoint
- `.pptx` - 73 файла (134.5 МБ)
- `.ppt` - 5 файлов (4.1 МБ)

#### PDF документы
- `.pdf` - 468 файлов (396.2 МБ)

### Данные и таблицы (920 файлов, 12.8%)

- `.csv` - 507 файлов (40.5 МБ)
- `.parquet` - 413 файлов (19.7 МБ) - формат Apache Parquet для больших данных

### Видео файлы (607 файлов, 8.4%)

- `.mp4` - 370 файлов (59.1 МБ)
- `.webm` - 237 файлов (61.2 МБ)

### Изображения (129 файлов, 1.8%)

- `.png` - 95 файлов (33.1 МБ)
- `.jpg` - 24 файла (4.6 МБ)
- `.jpeg` - 6 файлов (1017.3 КБ)
- `.svg` - 2 файла (275.5 КБ)
- `.tif` - 2 файла (3.2 МБ)

### Аудио файлы (9 файлов, 0.1%)

- `.ogg` - 4 файла (118.8 КБ)
- `.m4a` - 3 файла (160.5 КБ)
- `.mp3` - 2 файла (110.3 КБ)

### Архивы (64 файла, 0.9%)

**Теперь поддерживается конвертация!**

Архивы автоматически распаковываются, их содержимое конвертируется в Markdown:
- **ArchiveConverter** распаковывает архивы и обрабатывает файлы внутри
- Создается индексный файл (archive.zip.md) со списком содержимого
- Каждый файл из архива конвертируется отдельно (file.txt.md)
- Поддержка вложенных архивов с защитой от циклических зависимостей
- Рекурсивная обработка до 10 уровней вложенности

Поддерживаемые форматы:
- `.zip` - 62 файла (10.7 МБ) - встроенный zipfile
- `.7z` - 2 файла (165.4 МБ) - py7zr
- `.tar`, `.gz`, `.tgz` - встроенный tarfile
- `.rar` - rarfile (требует установки)

### Специализированные форматы

#### Проектное управление
- `.mpp` - 44 файла (93.7 МБ) - Microsoft Project

#### Аналитика и BI
- `.pbix` - 10 файлов (23.9 МБ) - Power BI

#### 1С Предприятие
- `.epf` - 11 файлов (287.0 КБ) - Внешние обработки
- `.erf` - 1 файл (5.0 КБ) - Внешние отчеты

#### Схемы и диаграммы
- `.drawio` - 22 файла (5.9 МБ)

#### Разработка
- `.avsc` - 24 файла (44.3 КБ) - Avro Schema
- `.py` - 1 файл (2.3 КБ) - Python скрипт
- `.json` - 1 файл (22.3 КБ)
- `.j2` - 2 файла (80.6 КБ) - Jinja2 шаблоны

### Прочие файлы

- `.txt` - 41 файл (562.0 КБ)
- `.tmp` - 18 файлов (24.3 МБ) - временные файлы
- `.xml` - 5 файлов (93.8 КБ)
- `.md` - 4 файла (451.2 КБ) - Markdown документация
- `.html/.htm` - 4 файла (235.1 КБ)
- `.rtf` - 1 файл (5.8 КБ)
- `.bkp` - 4 файла (4.2 КБ) - резервные копии
- `.snappy` - 4 файла (38.3 КБ) - Snappy сжатие
- Без расширения - 4 файла (0.0 Б)

## Полный список расширений (алфавитный порядок)

.2025, .7z, .avsc, .bkp, .csv, .doc, .docx, .drawio, .dtmp, .epf, .erf, .gz, .htm, .html, .j2, .jpeg, .jpg, .json, .lnk, .m4a, .md, .mht, .mp3, .mp4, .mpp, .ogg, .parquet, .pbix, .pdf, .png, .ppt, .pptx, .py, .rar, .rdp, .rtf, .sel, .snappy, .svg, .tar, .tgz, .tif, .tmp, .txt, .webm, .xls, .xlsb, .xlsm, .xlsx, .xml, .zip

## Таблица преобразования файлов в Markdown

| Расширение | Преобразование | Комментарий |
|------------|----------------|-------------|
| .2025 | ❌ Нет | Неизвестный формат |
| .7z | ✅ Да | **ArchiveConverter** (py7zr/patool) → распаковка + конвертация содержимого, создание индекса |
| .avsc | ✅ Да | **TextConverter** → Avro Schema (JSON) как code block |
| .bkp | ❌ Нет | Резервная копия - обычно не требуется |
| .csv | ✅ Да | **Pandas** → markdown таблицы (без лимитов) |
| .doc | ✅ Да | **Mammoth** (fallback: pandoc) → markdown (старый формат Word) |
| .docx | ✅ Да | **Mammoth** (fallback: pandoc) → markdown с сохранением форматирования |
| .drawio | ❌ Нет | Диаграммы - требуется экспорт в изображение |
| .dtmp | ❌ Нет | Временный файл |
| .epf | ❌ Нет | 1С Внешняя обработка - проприетарный формат |
| .erf | ❌ Нет | 1С Внешний отчет - проприетарный формат |
| .gz | ✅ Да | **ArchiveConverter** (встроенный tarfile) → распаковка + конвертация содержимого, создание индекса |
| .htm | ✅ Да | **HTMLConverter** (html2text или BeautifulSoup) → markdown |
| .html | ✅ Да | **HTMLConverter** (html2text или BeautifulSoup) → markdown |
| .j2 | ✅ Да | **TextConverter** → Jinja2 шаблон как code block |
| .jpeg | ❌ Нет | Изображение - игнорируется (по требованию) |
| .jpg | ❌ Нет | Изображение - игнорируется (по требованию) |
| .json | ✅ Да | **TextConverter** → JSON данные как code block |
| .lnk | ❌ Нет | Ярлык Windows - системный файл |
| .m4a | ❌ Нет | Аудио файл - только метаданные |
| .md | ✅ Да | **TextConverter** → Markdown уже в правильном формате |
| .mht | ❌ Нет | Веб-архив - сложный формат |
| .mp3 | ❌ Нет | Аудио файл - только метаданные |
| .mp4 | ❌ Нет | Видео файл - только метаданные |
| .mpp | ❌ Нет | Microsoft Project - проприетарный формат |
| .ogg | ❌ Нет | Аудио файл - только метаданные |
| .parquet | ✅ Да | **ParquetConverter** (Pandas + pyarrow) → markdown таблицы (без лимитов) |
| .pbix | ❌ Нет | Power BI - проприетарный формат |
| .pdf | ✅ Да | **pdfplumber** (fallback: PyPDF2) → markdown (текст без изображений, лимит: 100 страниц) |
| .png | ❌ Нет | Изображение - игнорируется (по требованию) |
| .ppt | ⚠️ Ограничено | **PowerPointConverter** - требует конвертации в .pptx (python-pptx не поддерживает старый формат) |
| .pptx | ✅ Да | **PowerPointConverter** (python-pptx) → markdown (каждый слайд = секция, текст и заметки) |
| .py | ✅ Да | **TextConverter** → Python скрипт как code block |
| .rar | ✅ Да | **ArchiveConverter** (rarfile/patool) → распаковка + конвертация содержимого, создание индекса |
| .rdp | ❌ Нет | Remote Desktop Protocol - конфигурационный файл |
| .rtf | ✅ Да | **RTFConverter** (pypandoc или striprtf) → markdown |
| .sel | ❌ Нет | Неизвестный формат |
| .snappy | ❌ Нет | Snappy сжатие - требуется распаковка |
| .svg | ❌ Нет | Изображение - игнорируется (по требованию) |
| .tar | ✅ Да | **ArchiveConverter** (встроенный tarfile) → распаковка + конвертация содержимого, создание индекса |
| .tif | ❌ Нет | Изображение - игнорируется (по требованию) |
| .tmp | ❌ Нет | Временный файл |
| .tgz | ✅ Да | **ArchiveConverter** (встроенный tarfile) → распаковка + конвертация содержимого, создание индекса |
| .txt | ✅ Да | **TextConverter** → текстовый файл как code block |
| .webm | ❌ Нет | Видео файл - только метаданные |
| .xls | ✅ Да | **Pandas (xlrd)** → markdown (каждый лист = секция, без лимитов) |
| .xlsb | ✅ Да | **Pandas (pyxlsb)** → markdown (бинарный формат Excel, без лимитов) |
| .xlsm | ✅ Да | **Pandas (openpyxl)** → markdown (макросы теряются, без лимитов) |
| .xlsx | ✅ Да | **Pandas (openpyxl)** → markdown (каждый лист = секция, без лимитов) |
| .xml | ✅ Да | **TextConverter** → XML данные как code block |
| .zip | ✅ Да | **ArchiveConverter** (встроенный zipfile) → распаковка + конвертация содержимого, создание индекса |
| (без расширения) | ❌ Нет | Неопределенный тип файла |

### Легенда

- ✅ **Да** - Реализовано и работает
- ⚠️ **Ограничено** - Работает с ограничениями (требуется доп. конвертация или установка ПО)
- ❌ **Нет** - Не преобразуется (технические ограничения или нецелесообразно)

### Статистика преобразования

**Текущее состояние (реализовано):**
- ✅ Word документы (.docx, .doc): 1,190 файлов (16.6%)
- ✅ CSV файлы: 507 файлов (7.1%)
- ✅ Excel файлы (.xlsx, .xlsm, .xls, .xlsb): 3,512 файлов (48.9%)
- ✅ PDF документы: 468 файлов (6.5%)
- ✅ PowerPoint (.pptx): 73 файла (1.0%)
- ✅ Parquet файлы: 413 файлов (5.7%)
- ✅ Текстовые/код (.txt, .md, .py, .json, .xml, .avsc, .j2): 78 файлов (1.1%)
- ✅ HTML/HTM: 4 файла (0.1%)
- ✅ RTF: 1 файл (0.0%)
- ✅ Архивы (.zip, .7z, .rar, .tar, .gz, .tgz): 64 файла (0.9%)
- **Итого преобразуется**: 6,310 файлов (87.8%)

**Ограниченная поддержка:**
- ⚠️ PowerPoint (.ppt) - старый формат: 5 файлов (0.1%)

**Не преобразуются:**
- ❌ Видео (.mp4, .webm): 607 файлов (8.4%)
- ❌ Изображения (.png, .jpg, .jpeg, .svg, .tif): 129 файлов (1.8%)
- ❌ Аудио (.mp3, .ogg, .m4a): 9 файлов (0.1%)
- ❌ Специализированные форматы (.mpp, .pbix, .epf, .erf, .drawio, .mht): 88 файлов (1.2%)
- ❌ Системные/временные файлы: 36 файлов (0.5%)

## Выводы и рекомендации

1. **Доминирование Excel файлов**: ~48% всех файлов - это Excel документы. Основная работа ведется с табличными данными.

2. **Большой объем офисных документов**: Excel + Word + PowerPoint + PDF составляют ~72% всех файлов.

3. **Видео контент**: 607 видеофайлов (~120 МБ) - относительно небольшой размер, возможно короткие демо или записи экрана.

4. **Данные для аналитики**: Наличие .parquet файлов указывает на работу с большими данными (Spark, Pandas, Arrow).

5. **Проектное управление**: 44 файла Microsoft Project (.mpp) - активное использование инструментов управления проектами.

6. **1С интеграция**: Присутствуют внешние обработки и отчеты 1С (.epf, .erf).

### Рекомендации по настройке синхронизации

#### Текущие настройки (config.py):

```python
# Пропускаемые видео файлы
VIDEO_EXTENSIONS = [
    '.mp4', '.avi', '.mov', '.mkv', '.webm',
    '.flv', '.wmv', '.m4v', '.mpg', '.mpeg',
    '.3gp', '.ogv', '.vob', '.ts'
]
```

#### Возможные дополнительные исключения:

1. **Временные файлы**: `.tmp`, `.dtmp` - можно пропускать
2. **Резервные копии**: `.bkp` - обычно не нужны для синхронизации
3. **Системные файлы**: `.lnk` (ярлыки Windows)

#### Файлы для особого внимания:

- **Большие Excel файлы**: `.xlsm` файлы занимают 1.5 ГБ - могут быть очень большими
- **Power BI**: `.pbix` файлы могут быть объемными и медленно синхронизироваться
- **Архивы**: `.zip`, `.7z`, `.rar`, `.tar`, `.gz` - теперь автоматически распаковываются и конвертируются

## Методология анализа

Анализ проведен с использованием скрипта `analyze_extensions.py`, который:

1. Рекурсивно сканирует всю папку `/Клиенты` на Яндекс.Диске
2. Собирает информацию о каждом файле (имя, размер, расширение)
3. Группирует файлы по расширениям
4. Подсчитывает количество и суммарный размер для каждого типа

Скрипт использует Token Exchange API для доступа к личному диску пользователя.

## Инфраструктура отслеживания конвертации

**Обновлено:** 15 января 2026

### База данных с Alembic миграциями

Проект использует SQLite базу данных для хранения метаданных синхронизации и отслеживания конвертации файлов:

#### Структура таблицы `files`:
```sql
CREATE TABLE files (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    path TEXT UNIQUE NOT NULL,           -- Относительный путь к файлу
    size INTEGER NOT NULL,                -- Размер файла в байтах
    modified TEXT NOT NULL,               -- Дата модификации на удаленном диске
    md5 TEXT,                            -- MD5 хеш файла
    last_sync TEXT NOT NULL,             -- Дата последней синхронизации
    is_empty INTEGER DEFAULT 0,          -- Флаг пустого файла (видео/большие)
    markdown_path TEXT,                  -- Путь к сконвертированному MD файлу
    created_at TEXT NOT NULL,            -- Дата создания записи
    updated_at TEXT NOT NULL             -- Дата обновления записи
);
```

#### Управление миграциями:

- **Alembic** - профессиональная система управления схемой БД
- **Автоматическое применение** - миграции применяются при запуске `run.py`
- **Версионирование** - все изменения схемы отслеживаются в git
- **Откат изменений** - возможность вернуться к предыдущей версии

Команды:
```bash
# Проверка текущей версии
alembic current

# Создание новой миграции
alembic revision -m "описание"

# Применение миграций (автоматически при run.py)
alembic upgrade head

# Откат миграции
alembic downgrade -1
```

### Отслеживание конвертации файлов

#### Поле `markdown_path`:

- Хранит **относительный путь** к сконвертированному MD файлу
- **Заполняется автоматически** при успешной конвертации
- **Пустое значение** если файл не конвертировался или конвертация отключена
- Используется для **инкрементальной конвертации**

#### Инкрементальная конвертация:

Скрипт `convert_to_markdown.py`:
1. Запрашивает из БД файлы с `markdown_path IS NULL OR markdown_path = ''`
2. Конвертирует только файлы без MD пути
3. Обновляет `markdown_path` после успешной конвертации
4. При повторном запуске пропускает уже обработанные файлы

Преимущества:
- ✅ Не дублируется работа при повторных запусках
- ✅ Можно прервать и продолжить конвертацию
- ✅ Отслеживание прогресса конвертации
- ✅ Автоматическая конвертация новых файлов

#### Пример использования:

```bash
# Синхронизация с автоматической конвертацией
python run.py

# Инкрементальная конвертация существующих файлов
python convert_to_markdown.py

# Проверка статуса конвертации
python -c "
from src.database import MetadataDatabase
from src import config
db = MetadataDatabase(config.METADATA_DB_PATH, auto_migrate=False)
files = db.get_all_files()
with_md = len([f for f in files if f['markdown_path']])
total = len(files)
print(f'Конвертировано: {with_md}/{total} файлов ({with_md/total*100:.1f}%)')
"
```

### Кросс-платформенность

#### Проверено на:
- ✅ **Windows 10/11** - полная функциональность
- ✅ **Ubuntu/Linux** - работает без проблем, лучше производительность
  - Нет блокировки временных файлов при распаковке архивов
  - Нативная поддержка UTF-8
  - Быстрее файловые операции

#### Установка на Ubuntu:

```bash
# Клонирование
git clone https://github.com/Sbitnev/sync_ya_disk.git
cd sync_ya_disk

# Виртуальное окружение
python3 -m venv .venv
source .venv/bin/activate

# Зависимости
pip install -r requirements.txt

# Настройка
cp .env.example .env
nano .env

# Запуск
python run.py
```

#### Опциональные зависимости для Ubuntu:

```bash
# Для .rar файлов (опционально)
sudo apt-get install unrar

# Для pandoc (опционально)
sudo apt-get install pandoc
```

### Мониторинг и отладка

#### Логи синхронизации:

- **Консоль**: Цветной вывод с временными метками
- **Файл**: `logs/sync_ya_disk.log` (ротация 10 МБ, хранение 7 дней, сжатие)

#### Проверка состояния БД:

```python
from src.database import MetadataDatabase
from src import config

db = MetadataDatabase(config.METADATA_DB_PATH, auto_migrate=False)

# Общая статистика
stats = db.get_statistics()
print(f"Всего файлов: {stats['total_files']}")
print(f"Реальных файлов: {stats['real_files']}")
print(f"Пустых файлов: {stats['empty_files']}")

# Файлы без конвертации
unconverted = db.get_files_without_markdown()
print(f"Файлов без MD: {len(unconverted)}")
```

### История обновлений

- **15 января 2026**:
  - Добавлен Alembic для управления миграциями БД
  - Добавлено поле `markdown_path` для отслеживания конвертации
  - Реализована инкрементальная конвертация
  - Автоматическое применение миграций при запуске

- **14 января 2026**:
  - Реализован ArchiveConverter с рекурсивной распаковкой
  - Добавлена поддержка .7z, .rar, .tar, .gz архивов
  - Защита от циклических архивов

- **Ранее**:
  - Реализованы конвертеры для Word, Excel, PDF, PowerPoint
  - Добавлена поддержка CSV, Parquet, HTML, RTF
  - Оптимизация получения списка файлов (3-5x ускорение)
