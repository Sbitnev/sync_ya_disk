# Отчет о проблеме автоматической выгрузки данных с Яндекс.Диска

## Суть проблемы

При автоматической выгрузке файлов из публичной папки Яндекс.Диска (`https://disk.yandex.ru/d/_JeaJNmm6UeQVA`) возникают критические ограничения API, препятствующие полной синхронизации данных.

## Техническая причина

**API Яндекс.Диска не возвращает прямые ссылки для скачивания файлов, находящихся в подпапках публичной ссылки**, если:
- У файлов нет собственного параметра `public_url`
- Владелец не создал отдельные публичные ссылки на подпапки

При попытке получить ссылку для скачивания API возвращает:
```json
{
  "method": "GET",
  "href": "",          // <- Пустая ссылка
  "templated": false
}
```

Дополнительно, **владелец папки запретил функцию "Сохранение на диск"** (ошибка 423 Read-Only), что блокирует обходные методы через сохранение папки на собственный диск.

## Статистика по файлам

**Всего файлов в папке:** 7,159
**Общий объем:** ~45.9 ГБ
**Структура:** 923 папки

### Что удалось скачать:
- ✅ **415 файлов (5.8%)** - файлы с собственными публичными ссылками
- ✅ **530 видео (7.4%)** - пропущены (созданы пустые файлы)
- ✅ **84 больших файла (1.2%)** - >300 МБ, пропущены
- ✅ **Полная структура папок** (923 папки)

### Что НЕ удалось скачать:
- ❌ **~6,000 файлов (83.5%)** - файлы в подпапках без `public_url`
- ❌ Включая папку **"Юн.Индастриал"** (3 файла, ~3.7 МБ)

## Проверенные методы (все не работают)

| Метод | Результат | Причина |
|-------|-----------|---------|
| REST API download | ❌ | `href: ''` - пустые ссылки |
| save-to-disk + download | ❌ | 423 - владелец запретил |
| WebDAV | ❌ | Работает только со своим диском |
| yadisk library | ❌ | Те же ограничения API |

## Возможные решения

### 1. **Токен владельца** ⭐ (ЛУЧШЕЕ РЕШЕНИЕ)

**Что нужно:**
Получить OAuth токен от владельца папки с правами `cloud_api:disk.read`

**Преимущества:**
- ✅ Решает проблему полностью
- ✅ Доступ ко всем файлам напрямую
- ✅ Стабильная автоматизация
- ✅ Не требует дополнительного ПО

**Недостатки:**
- ⚠️ Требует действий от владельца

**Время реализации:** 10 минут

---

### 2. **rclone** (АЛЬТЕРНАТИВА)

**Что нужно:**
Установить программу rclone и настроить OAuth

**Преимущества:**
- ✅ Специализированный инструмент
- ✅ Может обойти некоторые ограничения
- ✅ Инкрементальная синхронизация

**Недостатки:**
- ⚠️ Требует установки стороннего ПО
- ⚠️ Может не работать с этой конкретной папкой
- ⚠️ Требует OAuth от владельца

**Время реализации:** 30 минут

---

### 3. **Selenium (браузерная автоматизация)**

**Что нужно:**
Установить ChromeDriver, настроить автоматизацию браузера

**Преимущества:**
- ✅ Обходит ограничения API
- ✅ Гарантированно скачает всё

**Недостатки:**
- ⚠️ Медленно (~1-2 часа на 7000 файлов)
- ⚠️ Требует открытого браузера
- ⚠️ Может сломаться при изменениях UI
- ⚠️ Нестабильно для автоматизации

**Время реализации:** 2 часа + время скачивания

---

### 4. **Настройки доступа папки**

**Что нужно:**
Попросить владельца включить "Сохранение на диск" в настройках публичной ссылки

**Преимущества:**
- ✅ Разрешит использовать метод save-to-disk
- ✅ Стабильно работает

**Недостатки:**
- ⚠️ Занимает место на нашем Яндекс.Диске
- ⚠️ Требует действий от владельца

**Время реализации:** 5 минут + действия владельца

---

### 5. **Прямой доступ к папке**

**Что нужно:**
Попросить владельца расшарить папку напрямую (не через публичную ссылку)

**Преимущества:**
- ✅ Полный доступ ко всем файлам
- ✅ Нет ограничений

**Недостатки:**
- ⚠️ Требует действий от владельца
- ⚠️ Нужна учетная запись Яндекс

**Время реализации:** 10 минут

## Рекомендация

### Краткосрочно (сегодня):
**Скачать 3 файла из "Юн.Индастриал" вручную через браузер** (3.7 МБ, 2 минуты)

### Среднесрочно (на эту неделю):
**Получить токен владельца с правами чтения** - это полностью решит проблему автоматической синхронизации

### Долгосрочно:
Если получение токена невозможно, использовать **rclone** как запасной вариант

## Что уже сделано

1. ✅ Написан полнофункциональный скрипт синхронизации
2. ✅ Реализовано:
   - Многопоточная загрузка (5 потоков)
   - Retry при сетевых ошибках
   - Прогресс-бары
   - Инкрементальная синхронизация
   - Логирование
   - Санитизация имен файлов для Windows
3. ✅ Скачано 415 доступных файлов
4. ✅ Создана полная структура папок
5. ✅ Подготовлены альтернативные решения

## Требуемое действие

**Связаться с владельцем папки** и запросить:

### Вариант 1 (предпочтительно):
OAuth токен с правами `cloud_api:disk.read`

Инструкция для владельца:
1. Перейти на https://oauth.yandex.ru/authorize?response_type=token&client_id=1d48da71976f41fb871177f16ba4c6e7
2. Разрешить доступ
3. Скопировать токен из адресной строки
4. Передать токен безопасным способом

### Вариант 2 (альтернатива):
Разрешить "Сохранение на диск" в настройках публичной ссылки

### Вариант 3 (альтернатива):
Предоставить прямой доступ к папке (расшарить)

---

**Подготовил:** Разработчик
**Дата:** 13.01.2026
**Файлы проекта:** `C:\Users\sasha\vscode\imprice\mvps\sync_ya_disk\`
