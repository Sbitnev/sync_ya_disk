# Синхронизация Яндекс.Диска через Token Exchange

Приложение для синхронизации личных папок пользователей Яндекс 360 с локальной файловой системой.

## Особенности

- ✅ Доступ к личному диску через Token Exchange (RFC 8693)
- ✅ Автоматическое обновление токена (каждый час)
- ✅ SQLite база данных для хранения метаданных
- ✅ Управление схемой БД через Alembic миграции
- ✅ Инкрементальная синхронизация (пропуск неизмененных файлов)
- ✅ Автоматическая очистка удаленных файлов
- ✅ Пропуск больших файлов >1GB (не скачиваются)
- ✅ Лимит на общий объем загрузки (10GB)
- ✅ Многопоточная загрузка (5 потоков)
- ✅ Отслеживание изменений файлов (MD5, дата модификации)
- ✅ **Конвертация файлов в Markdown** (Word, Excel, PDF, PowerPoint, HTML, CSV, Parquet, RTF, архивы)
- ✅ **Транскрибация видео в текст** через Yandex SpeechKit (асинхронная обработка)
- ✅ **Умное кэширование** - пропуск повторной конвертации неизмененных файлов
- ✅ **Режим ручного выбора папок** - интерактивный выбор папок для синхронизации с анализом содержимого
- ✅ **Удаление оригиналов** после конвертации в MD (экономия места)

## Системные требования

### Обязательные компоненты

1. **Python 3.7+** с pip
2. **FFmpeg** - для извлечения аудио из видео файлов (транскрибация)
   - Windows: https://www.gyan.dev/ffmpeg/builds/ или `choco install ffmpeg`
   - Linux: `sudo apt-get install ffmpeg`
   - macOS: `brew install ffmpeg`

3. **Pandoc** - для конвертации старых .doc файлов
   - Windows: https://github.com/jgm/pandoc/releases/latest или `winget install JohnMacFarlane.Pandoc`
   - Linux: `sudo apt-get install pandoc`
   - macOS: `brew install pandoc`

### Python библиотеки

Все необходимые библиотеки перечислены в `requirements.txt`:

```
requests
python-dotenv
loguru
tqdm
alembic
sqlalchemy
# Конвертация документов
mammoth          # Word .docx → Markdown
openpyxl         # Excel
pdfminer.six     # PDF
python-pptx      # PowerPoint
pandas           # CSV, Parquet
pyarrow          # Parquet
beautifulsoup4   # HTML
striprtf         # RTF
py7zr            # Архивы 7z
# Обработка видео
imageio-ffmpeg   # FFmpeg wrapper
boto3            # AWS S3 для Yandex Object Storage
```

### Проверка установки

```bash
# Проверить Python
python --version

# Проверить FFmpeg
ffmpeg -version

# Проверить Pandoc
pandoc --version
```

## Требования к серверу

Для синхронизации папки **`/Клиенты`** (~220 ГБ необработанных данных) рекомендуются следующие характеристики сервера:

### Минимальная конфигурация

| Компонент | Минимум | Примечание |
|-----------|---------|------------|
| **CPU** | 2 ядра (2.0 GHz+) | Для FFmpeg и обработки документов |
| **RAM** | 4 ГБ | Для небольших файлов и последовательной обработки |
| **Диск** | 300 ГБ | 220 ГБ данные + 30 ГБ MD + 50 ГБ запас |
| **Сеть** | 10 Мбит/с | Загрузка ~60 часов |
| **ОС** | Linux/Windows Server | Ubuntu 20.04+ / Windows Server 2019+ |

### Рекомендуемая конфигурация

| Компонент | Рекомендуется | Примечание |
|-----------|---------------|------------|
| **CPU** | 4 ядра (2.5 GHz+) | Для параллельной обработки 5 потоков |
| **RAM** | 8 ГБ | Комфортная работа с большими Excel/PDF файлами |
| **Диск** | 350 ГБ SSD | SSD ускорит конвертацию и транскрибацию |
| **Сеть** | 100 Мбит/с | Загрузка ~5-6 часов |
| **ОС** | Linux | Ubuntu 22.04 LTS (оптимизирован для серверов) |

### Оптимальная конфигурация

| Компонент | Оптимально | Примечание |
|-----------|------------|------------|
| **CPU** | 8 ядер (3.0 GHz+) | Максимальная скорость обработки |
| **RAM** | 16 ГБ | Одновременная обработка нескольких больших файлов |
| **Диск** | 500 ГБ NVMe SSD | Максимальная производительность I/O |
| **Сеть** | 1 Гбит/с | Загрузка ~30-40 минут |
| **ОС** | Linux | Ubuntu 22.04 LTS |

### Расчет дискового пространства

```
220 ГБ - исходные данные (скачанные файлы)
+ 30 ГБ - конвертированные Markdown файлы (~13% от исходных)
+ 2 ГБ  - временные аудио файлы (макс. 3 видео одновременно)
+ 1 ГБ  - база данных SQLite и логи
+ 50 ГБ - резерв на рост данных
─────────
≈ 303 ГБ минимум
```

**Примечание:** Если включена опция `DELETE_ORIGINALS_AFTER_CONVERSION = True`, исходные файлы удаляются после конвертации в MD, что экономит ~190 ГБ места (остаются только видео и большие файлы).

### Оценка времени синхронизации

При первой синхронизации 220 ГБ данных:

| Скорость сети | Загрузка | Обработка* | Итого |
|---------------|----------|------------|-------|
| 10 Мбит/с | ~60 часов | ~10 часов | ~70 часов |
| 100 Мбит/с | ~6 часов | ~8 часов | ~14 часов |
| 1 Гбит/с | ~40 минут | ~6 часов | ~7 часов |

*Время обработки зависит от CPU, RAM и количества видео для транскрибации

### Требования к сетевому подключению

- **Стабильное соединение** для длительных загрузок
- **Белый IP** желателен для удаленного доступа к серверу
- **Неограниченный трафик** (минимум 300 ГБ входящего на первую синхронизацию)
- **Низкая латентность** к Yandex Cloud (для России - датацентры в РФ)

### Примеры подходящих серверов

**VPS/VDS провайдеры (Россия):**
- Yandex Cloud: s3-c4-m16 (4 vCPU, 16 GB RAM, 400 GB SSD) - ~4000₽/мес
- VK Cloud: STD3-4-8 (4 vCPU, 8 GB RAM, 350 GB SSD) - ~2500₽/мес
- Selectel: VDS-4-8-400 (4 vCPU, 8 GB RAM, 400 GB SSD) - ~3000₽/мес

**Bare Metal (выделенный сервер):**
- Hetzner: AX41 (8 cores, 32 GB RAM, 2x512 GB NVMe RAID) - ~50€/мес
- OVH: Rise-1 (4 cores, 16 GB RAM, 500 GB SSD) - ~40€/мес

**Преимущества Yandex Cloud:** Минимальная латентность к Yandex Disk API и Yandex SpeechKit

## Быстрый старт

### 1. Установка зависимостей

```bash
pip install -r requirements.txt
```

### 2. Настройка .env

Создайте файл `.env` в корне проекта:

```env
# Данные сервисного приложения
ClientID=your_client_id
Client_secret=your_client_secret

# Пользователь для синхронизации
USER_ID=1130000057842996
USER_EMAIL=user@domain.com
```

### 3. Запуск

```bash
python run.py
```

## Структура проекта

```
sync_ya_disk/
├── src/                      # Исходный код
│   ├── __init__.py          # Инициализация пакета
│   ├── main.py              # Точка входа
│   ├── config.py            # Конфигурация
│   ├── token_manager.py     # Управление токенами
│   ├── syncer.py            # Синхронизатор
│   └── utils.py             # Вспомогательные функции
├── run.py                   # Скрипт запуска
├── requirements.txt         # Зависимости
├── .env                     # Переменные окружения (не в git)
└── README.md               # Документация
```

## Конфигурация

Все настройки находятся в `src/config.py`:

### Основные параметры

```python
# Папка на диске для синхронизации
REMOTE_FOLDER_PATH = "/Клиенты"

# Локальная папка для всех данных (кроме логов)
LOCALDATA_DIR = Path("localdata")

# Папка для скачанных файлов
DOWNLOAD_DIR = LOCALDATA_DIR / "downloaded_files"

# Лимиты
MAX_FILE_SIZE = 1 * 1024 * 1024 * 1024  # 1 ГБ
MAX_TOTAL_SIZE = 10 * 1024 * 1024 * 1024  # 10 ГБ
```

### Режим ручного выбора папок

```python
# Включить интерактивный выбор папок перед синхронизацией
MANUAL_MODE = True

# При включении покажет список папок первого уровня с:
# - Размером каждой папки
# - Количеством файлов
# - Топ-5 типов файлов
# Можно выбрать конкретные папки для синхронизации
```

### Конвертация в Markdown

```python
# Включить конвертацию файлов в Markdown
ENABLE_MARKDOWN_CONVERSION = True

# Папка для сохранения MD файлов
MARKDOWN_OUTPUT_DIR = LOCALDATA_DIR / "markdown_files"

# Удалять оригинальные файлы после конвертации (экономия места)
DELETE_ORIGINALS_AFTER_CONVERSION = True

# Типы файлов для конвертации
CONVERT_WORD_FILES = True      # .docx, .doc
CONVERT_EXCEL_FILES = True     # .xlsx, .xls, .xlsm, .xlsb
CONVERT_PDF_FILES = True       # .pdf
CONVERT_POWERPOINT_FILES = True # .pptx, .ppt
CONVERT_CSV_FILES = True       # .csv
CONVERT_TEXT_FILES = True      # .txt, .md, .py, .json, .xml
CONVERT_HTML_FILES = True      # .html, .htm
CONVERT_PARQUET_FILES = True   # .parquet
CONVERT_RTF_FILES = True       # .rtf
CONVERT_ARCHIVE_FILES = True   # .zip, .7z, .rar, .tar, .gz
CONVERT_VIDEO_FILES = True     # Транскрибация видео через Yandex SpeechKit
```

### Транскрибация видео

```python
# Асинхронная обработка видео (не ждать завершения транскрибации)
VIDEO_ASYNC_TRANSCRIPTION = True

# Максимальное количество одновременных операций транскрибации
VIDEO_MAX_CONCURRENT_TRANSCRIPTIONS = 3

# Проверять незавершенные операции при запуске
VIDEO_CHECK_PENDING_ON_START = True

# Максимальный размер видео для транскрибации
VIDEO_MAX_SIZE = 500 * 1024 * 1024  # 500 МБ

# Требуется настроить в .env:
# - Yandex Cloud API ключ для SpeechKit
# - S3 бакет для временного хранения аудио
```

### Отключение лимитов

```python
# Отключить пропуск больших файлов
SKIP_LARGE_FILES = False

# Отключить лимит на общий объем
ENABLE_TOTAL_SIZE_LIMIT = False
```

## Как это работает

### 1. Token Exchange

Приложение использует Token Exchange (RFC 8693) для получения временного токена пользователя:

```python
POST https://oauth.yandex.ru/token
grant_type=urn:ietf:params:oauth:grant-type:token-exchange
client_id={CLIENT_ID}
client_secret={CLIENT_SECRET}
subject_token={USER_ID}
subject_token_type=urn:yandex:params:oauth:token-type:uid
```

### 2. Автоматическое обновление токена

Токен действителен 1 час. `TokenManager` автоматически обновляет его за 5 минут до истечения.

### 3. Синхронизация

1. Рекурсивно сканирует удаленную папку
2. **Режим manual**: Показывает список папок с анализом и ждет выбора пользователя
3. Проверяет незавершенные транскрибации видео из предыдущих запусков
4. Проверяет и удаляет файлы, отсутствующие на удаленном диске
5. Создает структуру папок локально
6. Скачивает только новые или измененные файлы (проверка через БД)
7. Пропускает файлы при превышении лимитов размера
8. **Конвертирует** файлы в Markdown (Word, Excel, PDF, PowerPoint и др.)
9. **Транскрибирует** видео в текст через Yandex SpeechKit (асинхронно)
10. Удаляет оригиналы после успешной конвертации (опционально)
11. Сохраняет метаданные в SQLite БД с отслеживанием статуса конвертации

### 4. Очистка удаленных файлов

При каждой синхронизации автоматически:
- Сравнивает файлы в БД со списком файлов на удаленном диске
- Удаляет локальные файлы, которых больше нет на диске
- Очищает записи из БД для удаленных файлов
- Удаляет пустые папки (если файлы в них были удалены)
- Выводит статистику удаленных файлов и папок

## Управление базой данных (Alembic)

Проект использует [Alembic](https://alembic.sqlalchemy.org/) для управления миграциями базы данных.

### Автоматическое применение миграций

Миграции применяются автоматически при запуске приложения. При первом запуске Alembic инициализируется для существующей БД.

### Создание новой миграции

```bash
# Создать миграцию для изменения схемы БД
alembic revision -m "описание_изменений"

# Применить миграции
alembic upgrade head

# Откатить миграцию
alembic downgrade -1
```

### Проверка состояния миграций

```bash
# Текущая версия БД
alembic current

# История миграций
alembic history
```

Подробная документация по работе с миграциями: [alembic/README_RU.md](alembic/README_RU.md)

## Документация

Подробная документация доступна в папке `docs/`:

- [QUICK_START.md](docs/QUICK_START.md) - Быстрый старт
- [DOCUMENTATION_TOKEN_EXCHANGE.md](docs/DOCUMENTATION_TOKEN_EXCHANGE.md) - Token Exchange
- [README_PROJECT.md](docs/README_PROJECT.md) - Полное описание проекта
- [INVESTIGATION_REPORT.md](docs/INVESTIGATION_REPORT.md) - Отчет об исследовании
- [PROBLEM_REPORT.md](docs/PROBLEM_REPORT.md) - Описание проблем

## Требования

### Системные
См. раздел [Системные требования](#системные-требования) выше для полного списка.

### Яндекс 360
- Сервисное приложение Яндекс 360 с правами на диск пользователей
- ID пользователя организации или email

### Yandex Cloud (для транскрибации видео)
- API ключ для Yandex SpeechKit
- S3 бакет для временного хранения аудио файлов
- Настройки в `.env`:
  ```env
  YC_API_KEY=your_yandex_cloud_api_key
  S3_BUCKET_NAME=your-bucket-name
  S3_ACCESS_KEY=your_s3_access_key
  S3_SECRET_KEY=your_s3_secret_key
  ```

## Лицензия

Проект создан для внутреннего использования и обучения.

## Автор

Создано с помощью **Claude Code** от Anthropic
