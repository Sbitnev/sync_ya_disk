# Синхронизация Яндекс.Диска через Token Exchange

Приложение для синхронизации личных папок пользователей Яндекс 360 с локальной файловой системой.

## Особенности

- ✅ Доступ к личному диску через Token Exchange (RFC 8693)
- ✅ Автоматическое обновление токена (каждый час)
- ✅ SQLite база данных для хранения метаданных
- ✅ Управление схемой БД через Alembic миграции
- ✅ Инкрементальная синхронизация (пропуск неизмененных файлов)
- ✅ Автоматическая очистка удаленных файлов
- ✅ Пропуск видео файлов (создаются пустые)
- ✅ Пропуск больших файлов >100MB (создаются пустые)
- ✅ Лимит на общий объем загрузки (10GB)
- ✅ Многопоточная загрузка (5 потоков)
- ✅ Отслеживание изменений файлов (MD5, дата модификации)

## Быстрый старт

### 1. Установка зависимостей

```bash
pip install -r requirements.txt
```

### 2. Настройка .env

Создайте файл `.env` в корне проекта:

```env
# Данные сервисного приложения
ClientID=your_client_id
Client_secret=your_client_secret

# Пользователь для синхронизации
USER_ID=1130000057842996
USER_EMAIL=user@domain.com
```

### 3. Запуск

```bash
python run.py
```

## Структура проекта

```
sync_ya_disk/
├── src/                      # Исходный код
│   ├── __init__.py          # Инициализация пакета
│   ├── main.py              # Точка входа
│   ├── config.py            # Конфигурация
│   ├── token_manager.py     # Управление токенами
│   ├── syncer.py            # Синхронизатор
│   └── utils.py             # Вспомогательные функции
├── run.py                   # Скрипт запуска
├── requirements.txt         # Зависимости
├── .env                     # Переменные окружения (не в git)
└── README.md               # Документация
```

## Конфигурация

Все настройки находятся в `src/config.py`:

### Основные параметры

```python
# Папка на диске для синхронизации
REMOTE_FOLDER_PATH = "/Клиенты"

# Локальная папка для всех данных (кроме логов)
LOCALDATA_DIR = Path("localdata")

# Папка для скачанных файлов
DOWNLOAD_DIR = LOCALDATA_DIR / "downloaded_files"

# Лимиты
MAX_FILE_SIZE = 100 * 1024 * 1024  # 100 МБ
MAX_TOTAL_SIZE = 10 * 1024 * 1024 * 1024  # 10 ГБ
```

### Отключение лимитов

```python
# Отключить пропуск видео
SKIP_VIDEO_FILES = False

# Отключить пропуск больших файлов
SKIP_LARGE_FILES = False

# Отключить лимит на общий объем
ENABLE_TOTAL_SIZE_LIMIT = False
```

## Как это работает

### 1. Token Exchange

Приложение использует Token Exchange (RFC 8693) для получения временного токена пользователя:

```python
POST https://oauth.yandex.ru/token
grant_type=urn:ietf:params:oauth:grant-type:token-exchange
client_id={CLIENT_ID}
client_secret={CLIENT_SECRET}
subject_token={USER_ID}
subject_token_type=urn:yandex:params:oauth:token-type:uid
```

### 2. Автоматическое обновление токена

Токен действителен 1 час. `TokenManager` автоматически обновляет его за 5 минут до истечения.

### 3. Синхронизация

1. Рекурсивно сканирует удаленную папку
2. Проверяет и удаляет файлы, отсутствующие на удаленном диске
3. Создает структуру папок локально
4. Скачивает только новые или измененные файлы
5. Создает пустые файлы для видео и больших файлов
6. Сохраняет метаданные в SQLite БД сразу после каждого файла

### 4. Очистка удаленных файлов

При каждой синхронизации автоматически:
- Сравнивает файлы в БД со списком файлов на удаленном диске
- Удаляет локальные файлы, которых больше нет на диске
- Очищает записи из БД для удаленных файлов
- Удаляет пустые папки (если файлы в них были удалены)
- Выводит статистику удаленных файлов и папок

## Управление базой данных (Alembic)

Проект использует [Alembic](https://alembic.sqlalchemy.org/) для управления миграциями базы данных.

### Автоматическое применение миграций

Миграции применяются автоматически при запуске приложения. При первом запуске Alembic инициализируется для существующей БД.

### Создание новой миграции

```bash
# Создать миграцию для изменения схемы БД
alembic revision -m "описание_изменений"

# Применить миграции
alembic upgrade head

# Откатить миграцию
alembic downgrade -1
```

### Проверка состояния миграций

```bash
# Текущая версия БД
alembic current

# История миграций
alembic history
```

Подробная документация по работе с миграциями: [alembic/README_RU.md](alembic/README_RU.md)

## Документация

Подробная документация доступна в папке `docs/`:

- [QUICK_START.md](docs/QUICK_START.md) - Быстрый старт
- [DOCUMENTATION_TOKEN_EXCHANGE.md](docs/DOCUMENTATION_TOKEN_EXCHANGE.md) - Token Exchange
- [README_PROJECT.md](docs/README_PROJECT.md) - Полное описание проекта
- [INVESTIGATION_REPORT.md](docs/INVESTIGATION_REPORT.md) - Отчет об исследовании
- [PROBLEM_REPORT.md](docs/PROBLEM_REPORT.md) - Описание проблем

## Требования

- Python 3.7+
- Сервисное приложение Яндекс 360 с правами на диск
- ID пользователя организации

## Лицензия

Проект создан для внутреннего использования и обучения.

## Автор

Создано с помощью **Claude Code** от Anthropic
